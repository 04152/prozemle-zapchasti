{% extends "base.html" %}

{% block content %}
<div class="pa-card pa-card-filters">
    <div class="pa-filters-header">
        <h2>–ö–∞—Ç–∞–ª–æ–≥–∏ –∑–∞–ø—á–∞—Å—Ç–µ–π —Ç–µ—Ö–Ω–∏–∫–∏</h2>

        <!-- –ö–Ω–æ–ø–∫–∞ –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è –±–∞–∑—ã —Å –ø–∞—Ä–æ–ª–µ–º -->
        <form method="post" action="{{ url_for('refresh') }}" class="pa-refresh-form">
            <input type="password"
                   name="token"
                   class="pa-input-token"
                   placeholder="–ü–∞—Ä–æ–ª—å">
            <button type="submit" class="pa-button-secondary">
                –û–±–Ω–æ–≤–∏—Ç—å –±–∞–∑—É –∏–∑ Excel
            </button>
        </form>
    </div>

    <!-- –°–æ–æ–±—â–µ–Ω–∏—è (flash) -->
    {% with messages = get_flashed_messages(with_categories=true) %}
      {% if messages %}
        <div class="pa-flash-container">
          {% for category, message in messages %}
            <div class="pa-flash pa-flash-{{ category }}">
              {{ message }}
            </div>
          {% endfor %}
        </div>
      {% endif %}
    {% endwith %}

    <form method="get" class="pa-filters">
        <div class="pa-filters-row">
            <label>
                –ì—Ä—É–ø–ø–∞ —Ç–µ—Ö–Ω–∏–∫–∏
                <select name="group">
                    <option value="">–í—Å–µ</option>
                    {% for g in groups %}
                        <option value="{{ g }}"
                                {% if g == current_group %}selected{% endif %}>
                            {{ g }}
                        </option>
                    {% endfor %}
                </select>
            </label>

            <label>
                –ú–æ–¥–µ–ª—å (—Ñ—Ä–∞–≥–º–µ–Ω—Ç)
                <input type="text" name="model"
                       value="{{ current_model }}"
                       placeholder="–ù–∞–ø—Ä–∏–º–µ—Ä: –ù–∏–≤–∞, –ú–¢–ó-82, 5551">
            </label>
        </div>

        <div class="pa-filters-row">
            <label>
                –¢–∏–ø –∫–∞—Ç–∞–ª–æ–≥–∞
                <select name="catalog_type">
                    <option value="">–í—Å–µ</option>
                    {% for t in catalog_types %}
                        <option value="{{ t }}"
                                {% if t == current_type %}selected{% endif %}>
                            {{ t }}
                        </option>
                    {% endfor %}
                </select>
            </label>

            <label>
                –°—Ç—Ä–∞–Ω–∞ —Å–∞–π—Ç–∞
                <select name="country">
                    <option value="">–í—Å–µ</option>
                    {% for c in countries %}
                        {% if c %}
                            <option value="{{ c }}"
                                    {% if c == current_country %}selected{% endif %}>
                                {{ c }}
                            </option>
                        {% endif %}
                    {% endfor %}
                </select>
            </label>
        </div>

        <div class="pa-filters-row">
            <label style="flex: 1 1 100%;">
                –ü–æ–∏—Å–∫ –ø–æ –º–æ–¥–µ–ª–∏ / –æ–ø–∏—Å–∞–Ω–∏—é / —Å—Å—ã–ª–∫–µ / –Ω–æ–º–µ—Ä–∞–º
                <input type="text" name="query"
                       value="{{ current_query }}"
                       placeholder="–ù–∞–ø—Ä–∏–º–µ—Ä: niva 21213 –º–æ—Å—Ç –∏–ª–∏ 01.2022">
            </label>
        </div>

        <div class="pa-filters-row">
            <label class="pa-checkbox-inline">
                <input type="checkbox" name="favorites_only" value="1"
                       {% if favorites_only %}checked{% endif %}>
                –¢–æ–ª—å–∫–æ –∏–∑–±—Ä–∞–Ω–Ω—ã–µ
            </label>
        </div>

        <div class="pa-filters-actions">
            <button type="submit" class="pa-button-primary">
                –ù–∞–π—Ç–∏
            </button>
            <a href="{{ url_for('index') }}" class="pa-button-secondary">
                –°–±—Ä–æ—Å–∏—Ç—å
            </a>
        </div>

        <div class="pa-hints">
            <strong>–ü—Ä–∏–º–µ—Ä—ã –∑–∞–ø—Ä–æ—Å–æ–≤:</strong>
            <span>¬´niva 21213¬ª</span>
            <span>¬´–°–ö-5 –ù–∏–≤–∞¬ª</span>
            <span>¬´mtz 82 –∫–∞—Ç–∞–ª–æ–≥ pdf¬ª</span>
            <span>¬´01.2022¬ª</span>
        </div>
    </form>

    <div class="pa-aux-blocks">
        <div class="pa-aux-block">
            <h4>–ü–æ—Å–ª–µ–¥–Ω–∏–µ –∑–∞–ø—Ä–æ—Å—ã</h4>
            {% if recent_searches %}
                <ul class="pa-aux-list">
                    {% for s in recent_searches %}
                        <li>
                            <a href="{{ url_for('index',
                                                group=s.group_name,
                                                model=s.model_fragment,
                                                catalog_type=s.catalog_type,
                                                country=s.country,
                                                query=s.query) }}">
                                {% if s.query %}
                                    ¬´{{ s.query }}¬ª
                                {% else %}
                                    –±–µ–∑ —Ç–µ–∫—Å—Ç–æ–≤–æ–≥–æ –ø–æ–∏—Å–∫–∞
                                {% endif %}
                                {% if s.group_name %}
                                    <span class="pa-aux-tag">{{ s.group_name }}</span>
                                {% endif %}
                                {% if s.model_fragment %}
                                    <span class="pa-aux-tag">{{ s.model_fragment }}</span>
                                {% endif %}
                                {% if s.catalog_type %}
                                    <span class="pa-aux-tag">{{ s.catalog_type }}</span>
                                {% endif %}
                                {% if s.country %}
                                    <span class="pa-aux-tag">{{ s.country }}</span>
                                {% endif %}
                            </a>
                        </li>
                    {% endfor %}
                </ul>
            {% else %}
                <p class="pa-aux-empty">–ü–æ–∫–∞ –Ω–µ—Ç –∏—Å—Ç–æ—Ä–∏–∏ –∑–∞–ø—Ä–æ—Å–æ–≤.</p>
            {% endif %}
        </div>

        <div class="pa-aux-block">
            <h4>–°–æ—Ö—Ä–∞–Ω—ë–Ω–Ω—ã–µ —à–∞–±–ª–æ–Ω—ã</h4>

            <form method="post"
                  action="{{ url_for('save_query') }}"
                  class="pa-save-query-form">
                <input type="hidden" name="group" value="{{ current_group }}">
                <input type="hidden" name="model" value="{{ current_model }}">
                <input type="hidden" name="catalog_type" value="{{ current_type }}">
                <input type="hidden" name="query" value="{{ current_query }}">
                <input type="hidden" name="country" value="{{ current_country }}">
                <input type="hidden" name="favorites_only" value="{{ '1' if favorites_only else '' }}">

                <input type="text" name="title" placeholder="–ù–∞–∑–≤–∞–Ω–∏–µ —à–∞–±–ª–æ–Ω–∞">
                <button type="submit" class="pa-button-secondary pa-button-small">
                    –°–æ—Ö—Ä–∞–Ω–∏—Ç—å —Ç–µ–∫—É—â–∏–π –∑–∞–ø—Ä–æ—Å
                </button>
            </form>

            {% if saved_queries %}
                <ul class="pa-aux-list">
                    {% for q in saved_queries %}
                        <li>
                            <a href="{{ url_for('use_query', query_id=q.id) }}">
                                {{ q.title }}
                                {% if q.group_name %}
                                    <span class="pa-aux-tag">{{ q.group_name }}</span>
                                {% endif %}
                                {% if q.model_fragment %}
                                    <span class="pa-aux-tag">{{ q.model_fragment }}</span>
                                {% endif %}
                                {% if q.catalog_type %}
                                    <span class="pa-aux-tag">{{ q.catalog_type }}</span>
                                {% endif %}
                                {% if q.country %}
                                    <span class="pa-aux-tag">{{ q.country }}</span>
                                {% endif %}
                                {% if q.query %}
                                    <span class="pa-aux-tag">¬´{{ q.query }}¬ª</span>
                                {% endif %}
                            </a>
                        </li>
                    {% endfor %}
                </ul>
            {% else %}
                <p class="pa-aux-empty">–®–∞–±–ª–æ–Ω–æ–≤ –µ—â—ë –Ω–µ—Ç.</p>
            {% endif %}
        </div>
    </div>
</div>

<div class="pa-card">
    <div class="pa-results-header">
        <h3>–†–µ–∑—É–ª—å—Ç–∞—Ç—ã –ø–æ–∏—Å–∫–∞</h3>
        <span class="pa-results-count">
            {{ records|length }} –∑–∞–ø–∏—Å–µ–π
        </span>
    </div>

    {% if records %}
        <div class="pa-table-wrapper">
            <table class="pa-table">
                <thead>
                <tr>
                    <th>–ì—Ä—É–ø–ø–∞ —Ç–µ—Ö–Ω–∏–∫–∏</th>
                    <th>–ú–æ–¥–µ–ª–∏</th>
                    <th>–¢–∏–ø</th>
                    <th>–°—Ç–∞—Ç—É—Å</th>
                    <th>–û–ø–∏—Å–∞–Ω–∏–µ</th>
                    <th>–ò—Å—Ç–æ—á–Ω–∏–∫</th>
                    <th>–°—Å—ã–ª–∫–∞</th>
                </tr>
                </thead>
                <tbody>
                {% for row in records %}
                    <tr>
                        <td>{{ row.group_name }}</td>
                        <td>{{ row.models | highlight(current_query) }}</td>
                        <td>{{ row.catalog_type }}</td>
                        <td>
                            {% if row.status %}
                                <span class="pa-status pa-status-{{ row.status|lower|replace(' ', '-') }}">
                                    {{ row.status }}
                                </span>
                            {% else %}
                                <span class="pa-status pa-status-unknown">‚Äî</span>
                            {% endif %}
                        </td>
                        <td class="pa-col-description">
                            {{ row.description | highlight(current_query) }}
                            <a href="{{ url_for('edit_note',
                                                catalog_id=row.id,
                                                group=current_group,
                                                model=current_model,
                                                catalog_type=current_type,
                                                query=current_query,
                                                country=current_country,
                                                favorites_only='1' if favorites_only else '') }}"
                               class="pa-note-link"
                               title="{% if row.engineer_note %}{{ row.engineer_note }}{% else %}–î–æ–±–∞–≤–∏—Ç—å –ø—Ä–∏–º–µ—á–∞–Ω–∏–µ{% endif %}">
                                üìù
                            </a>
                        </td>
                        <td>
                            {{ row.domain }}
                            {% if row.source_country %}
                                <span class="pa-badge-country">{{ row.source_country }}</span>
                            {% endif %}
                            {% if row.source_type %}
                                <span class="pa-badge-source">{{ row.source_type }}</span>
                            {% endif %}

                            <form method="post"
                                  action="{{ url_for('toggle_favorite', catalog_id=row.id) }}"
                                  class="pa-fav-form">
                                <input type="hidden" name="group" value="{{ current_group }}">
                                <input type="hidden" name="model" value="{{ current_model }}">
                                <input type="hidden" name="catalog_type" value="{{ current_type }}">
                                <input type="hidden" name="query" value="{{ current_query }}">
                                <input type="hidden" name="country" value="{{ current_country }}">
                                <input type="hidden" name="favorites_only" value="{{ '1' if favorites_only else '' }}">
                                <button type="submit"
                                        class="pa-star-button"
                                        title="–ü–µ—Ä–µ–∫–ª—é—á–∏—Ç—å –∏–∑–±—Ä–∞–Ω–Ω–æ–µ">
                                    {% if row.favorite %}
                                        ‚òÖ
                                    {% else %}
                                        ‚òÜ
                                    {% endif %}
                                </button>
                            </form>
                        </td>
                        <td>
                            <a href="{{ url_for('open_catalog', catalog_id=row.id) }}"
                               target="_blank"
                               rel="noopener"
                               class="pa-link-button">
                                –û—Ç–∫—Ä—ã—Ç—å
                            </a>
                        </td>
                    </tr>
                {% endfor %}
                </tbody>
            </table>
        </div>
    {% else %}
        <p>–ü–æ –∑–∞–¥–∞–Ω–Ω—ã–º —É—Å–ª–æ–≤–∏—è–º –Ω–∏—á–µ–≥–æ –Ω–µ –Ω–∞–π–¥–µ–Ω–æ.
            –ü–æ–ø—Ä–æ–±—É–π –æ—Å–ª–∞–±–∏—Ç—å —Ñ–∏–ª—å—Ç—Ä—ã –∏–ª–∏ –∏–∑–º–µ–Ω–∏—Ç—å –∑–∞–ø—Ä–æ—Å.</p>
    {% endif %}
</div>
{% endblock %}
